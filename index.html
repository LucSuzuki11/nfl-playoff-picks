<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NFL Playoff Picks</title>
  <style>
    body { font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial; margin: 18px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 14px; margin: 12px 0; }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    input[type="number"], input[type="text"] { padding: 10px; border: 1px solid #ccc; border-radius: 10px; }
    input[type="number"] { width: 110px; }
    input[type="text"] { width: 240px; }
    button { padding: 12px 14px; border: 0; border-radius: 12px; background: #111; color: #fff; font-weight: 600; }
    .muted { color: #666; font-size: 14px; }
    .winner { font-weight: 800; }
    .error { color: #b00020; font-weight: 700; }
    .ok { color: #0a7a2f; font-weight: 700; }
  </style>
</head>
<body>
  <h2>NFL Playoff Picks</h2>
  <div class="muted" id="roundLabel"></div>

  <div class="card">
    <div class="row">
      <label>
        Your name<br />
        <input id="name" type="text" placeholder="Your name" />
      </label>
      <div class="muted">Winner is auto-decided by scores.</div>
    </div>
  </div>

  <div id="games"></div>

  <button id="submitBtn">Submit Picks</button>
  <p id="status" class="muted"></p>

  <!-- DEBUG VIEW: shows OK or ERROR returned by Apps Script.
       Once it's working, you can hide it by changing style to display:none -->
  <iframe name="hidden_iframe" style="display:none;"></iframe>

  <!-- Hidden POST form (CORS-proof) -->
  <form id="postForm" target="resultFrame" method="POST" style="display:none;">
    <input name="round" id="f_round" />
    <input name="name" id="f_name" />
    <textarea name="picks" id="f_picks"></textarea>
  </form>

  <section id="leaderboard" style="margin-top:18px;">
  <div style="display:flex; align-items:baseline; justify-content:space-between; gap:12px; flex-wrap:wrap;">
    <h2 style="margin:0;">Leaderboard</h2>
    <div style="display:flex; gap:8px; align-items:center;">
      <button id="refreshLbBtn" type="button" style="padding:10px 12px; border-radius:12px;">Refresh</button>
      <div id="lbStatus" class="muted"></div>
    </div>
  </div>

  <div style="margin-top:10px; overflow:auto; border:1px solid var(--border); border-radius:14px;">
    <table id="lbTable" style="width:100%; border-collapse:collapse; min-width:420px;">
      <thead>
        <tr>
          <th style="text-align:left; padding:10px; border-bottom:1px solid var(--border);">Rank</th>
          <th style="text-align:left; padding:10px; border-bottom:1px solid var(--border);">Name</th>
          <th style="text-align:left; padding:10px; border-bottom:1px solid var(--border);">Correct</th>
          <th style="text-align:left; padding:10px; border-bottom:1px solid var(--border);">Score</th>
          <th style="text-align:left; padding:10px; border-bottom:1px solid var(--border);">Updated</th>
        </tr>
      </thead>
      <tbody id="lbBody"></tbody>
    </table>
  </div>
</section>

<script>
  // Your Apps Script Web App URL (must end in /exec)
  const API_URL = "https://script.google.com/macros/s/AKfycbxMFZyXBzvDM7hCvZCSs1fe1nFUaZIdnqA3meo6r-K4hpW-tYkoLCIw5qumix35cMy_/exec";

  // Update these each round
  const ROUND = "Wild Card";
  const MATCHUPS = [
    { matchId: "WC1", teamA: "Chargers", teamB: "Patriots" },
    { matchId: "WC2", teamA: "Bills", teamB: "Jaguars" },
    { matchId: "WC3", teamA: "Texans", teamB: "Steelers" },
    { matchId: "WC4", teamA: "Packers", teamB: "Bears" },
    { matchId: "WC5", teamA: "49ers", teamB: "Eagles" },
    { matchId: "WC6", teamA: "Rams", teamB: "Panthers" }
  ];

  document.getElementById("roundLabel").textContent = `Round: ${ROUND}`;

  const gamesEl = document.getElementById("games");

  function assertValidApiUrl(url) {
    if (!url.startsWith("https://script.google.com/macros/s/")) {
      throw new Error("API_URL must start with https://script.google.com/macros/s/");
    }
    if (!url.endsWith("/exec")) {
      throw new Error("API_URL must end with /exec");
    }
  }

  function winnerFromScores(a, b, teamA, teamB) {
    if (a > b) return teamA;
    if (b > a) return teamB;
    return "TIE";
  }

  function makeGameCard(m, idx) {
    const idA = `a_${idx}`, idB = `b_${idx}`, winId = `w_${idx}`;
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <div><b>${m.teamA}</b> vs <b>${m.teamB}</b></div>
      <div class="row" style="margin-top:10px;">
        <label>${m.teamA} score<br><input type="number" min="0" max="99" step="1" id="${idA}" /></label>
        <label>${m.teamB} score<br><input type="number" min="0" max="99" step="1" id="${idB}" /></label>
        <div class="muted">Winner: <span class="winner" id="${winId}">—</span></div>
      </div>
      <div class="muted">Match ID: ${m.matchId}</div>
    `;

    const aEl = div.querySelector(`#${idA}`);
    const bEl = div.querySelector(`#${idB}`);
    const wEl = div.querySelector(`#${winId}`);

    function update() {
      if (aEl.value === "" || bEl.value === "") { wEl.textContent = "—"; return; }
      const a = Number(aEl.value);
      const b = Number(bEl.value);
      wEl.textContent = winnerFromScores(a, b, m.teamA, m.teamB);
    }

    aEl.addEventListener("input", update);
    bEl.addEventListener("input", update);

    return div;
  }

  MATCHUPS.forEach((m, idx) => gamesEl.appendChild(makeGameCard(m, idx)));

  function getPicks() {
    const picks = [];
    for (let i = 0; i < MATCHUPS.length; i++) {
      const m = MATCHUPS[i];
      const scoreAEl = document.getElementById(`a_${i}`);
      const scoreBEl = document.getElementById(`b_${i}`);

      if (scoreAEl.value === "" || scoreBEl.value === "") {
        throw new Error(`Missing score for: ${m.teamA} vs ${m.teamB}`);
      }

      const scoreA = Number(scoreAEl.value);
      const scoreB = Number(scoreBEl.value);

      if (!Number.isInteger(scoreA) || !Number.isInteger(scoreB) || scoreA < 0 || scoreB < 0 || scoreA > 99 || scoreB > 99) {
        throw new Error(`Invalid score for: ${m.teamA} vs ${m.teamB}`);
      }

      const winner = winnerFromScores(scoreA, scoreB, m.teamA, m.teamB);

      picks.push({
        matchId: m.matchId,
        teamA: m.teamA,
        teamB: m.teamB,
        scoreA,
        scoreB,
        winner
      });
    }
    return picks;
  }

  document.getElementById("submitBtn").addEventListener("click", () => {
    const status = document.getElementById("status");
    status.className = "muted";
    status.textContent = "";

    try {
      assertValidApiUrl(API_URL);

      const name = document.getElementById("name").value.trim();
      if (!name) throw new Error("Please enter your name.");

      const picks = getPicks();

      const form = document.getElementById("postForm");
      form.action = API_URL;

      document.getElementById("f_round").value = ROUND;
      document.getElementById("f_name").value = name;
      document.getElementById("f_picks").value = JSON.stringify(picks);

      // submit to iframe, which will show OK or ERROR
      form.submit();

      status.className = "ok";
      status.textContent = "Submitted ✅";
    } catch (e) {
      status.className = "error";
      status.textContent = e.message;
    }
  });
</script>
<script>
  function loadLeaderboard() {
    const status = document.getElementById("lbStatus");
    if (!status) return;

    status.textContent = "Loading…";

    // JSONP callback name must be unique to avoid caching collisions
    const cb = "lb_cb_" + Math.random().toString(16).slice(2);

    window[cb] = function(payload) {
      try {
        delete window[cb];

        if (!payload || !payload.ok) {
          status.textContent = payload?.error ? `Error: ${payload.error}` : "Error loading leaderboard";
          return;
        }

        const rows = payload.rows || [];

        // Normalize/Sort: highest Score first; tie-break by Correct
        rows.sort((a,b)=>{
          const sA = Number(a.Score ?? 0), sB = Number(b.Score ?? 0);
          if (sB !== sA) return sB - sA;
          const cA = Number(a.Correct ?? 0), cB = Number(b.Correct ?? 0);
          return cB - cA;
        });

        const body = document.getElementById("lbBody");
        body.innerHTML = "";

        rows.forEach((r, i)=>{
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td style="padding:10px; border-bottom:1px solid var(--border);">${i+1}</td>
            <td style="padding:10px; border-bottom:1px solid var(--border);">${escapeHtml(String(r.Name ?? ""))}</td>
            <td style="padding:10px; border-bottom:1px solid var(--border);">${escapeHtml(String(r.Correct ?? ""))}</td>
            <td style="padding:10px; border-bottom:1px solid var(--border); font-weight:800;">${escapeHtml(String(r.Score ?? ""))}</td>
            <td style="padding:10px; border-bottom:1px solid var(--border); color:var(--muted);">${escapeHtml(String(r.Updated ?? ""))}</td>
          `;
          body.appendChild(tr);
        });

        status.textContent = rows.length ? `Updated (${rows.length} players)` : "No rows yet";
      } catch (err) {
        status.textContent = "Error rendering leaderboard";
      }
    };

    // Create a script tag to load JSONP
    const s = document.createElement("script");
    s.src = `${API_URL}?action=leaderboard&callback=${cb}&_=${Date.now()}`;
    s.onerror = () => { status.textContent = "Failed to load leaderboard"; };
    document.body.appendChild(s);

    // Cleanup script tag after load
    s.onload = () => { setTimeout(()=> s.remove(), 250); };
  }

  // tiny sanitizer for table cells
  function escapeHtml(str){
    return str
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // hook up button + auto refresh every 60s
  document.addEventListener("DOMContentLoaded", ()=>{
    const btn = document.getElementById("refreshLbBtn");
    if (btn) btn.addEventListener("click", loadLeaderboard);

    // initial load
    loadLeaderboard();

    // refresh every 60 seconds (optional)
    setInterval(loadLeaderboard, 60000);
  });
</script>
</body>
</html>